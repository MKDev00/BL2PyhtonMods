name: Manual Package and Release

on:
  workflow_dispatch:
    inputs:
      output-file-name:
        description: 'Output zip file name'
        required: true
        default: 'package'
      release-name:
        description: 'Release name'
        required: true
        default: 'Manual Release'

permissions:
  actions: write
  contents: write
  releases: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Fetch all history to create tags

      - name: Package folders
        run: |
          zip -r ${GITHUB_WORKSPACE}/${{ github.event.inputs.output-file-name }}.zip . -x '.git*' '.gitignore'

      - name: Create tag
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a release -m "Manual release created by GitHub Actions"
          git push origin release

      - name: Create release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          draft: false
          prerelease: false
          release_name: ${{ github.event.inputs.release-name }}
          tag_name: release
          body: 'Manual release created by GitHub Actions'

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ github.event.inputs.output-file-name }}.zip
          asset_name: ${{ github.event.inputs.output-file-name }}.zip
          asset_content_type: application/zip
